
- name: Join worker nodes to the Kubernetes cluster
  hosts: workers
  become: true
  gather_facts: false
  tasks:
    - name: Generate a fresh join command on the master (runs only once)
      shell: kubeadm token create --print-join-command
      register: join_command_raw
      delegate_to: "{{ groups['masters'][0] }}"
      run_once: true
      changed_when: true

    - name: Set the join command as a fact for all workers
      set_fact:
        join_command: "{{ join_command_raw.stdout }}"
      run_once: true

    - name: Join the cluster
      ansible.builtin.shell: >
        {{ join_command }}
        --ignore-preflight-errors=NumCPU,Mem,Swap,FileExisting-conntrack
        >> node_joined.txt
      args:
        chdir: $HOME
        creates: node_joined.txt       # ← idempotent – skips if already joined
